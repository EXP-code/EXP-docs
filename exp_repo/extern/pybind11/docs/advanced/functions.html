<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Functions &mdash; EXP 0.172 documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=9c6809b7"></script>
        <script src="../../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../../_static/copybutton.js?v=5eb1bb1e"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            EXP
              <img src="../../../../../_static/exp_logo_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                7.x
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">First steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/overview.html">EXP at a glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/install.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro/tutorial.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">EXP concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/bfetheory.html">BFE theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/codeintro.html">Code intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/timesseries.html">BFE time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/multistep.html">N-Body optimization in EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/centering.html">Centering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/yamlconfig.html">What is YAML?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/yamlconfig.html#an-annotated-exp-yaml-configuration">An annotated EXP YAML configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/howtosim.html">How to run your own N-body simulation in EXP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions (FAQ)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html">Are there pre-compiled versions of pyEXP and EXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#i-only-want-pyexp-do-i-need-c-to-compile-exp">I only want pyEXP, do I need C++ to compile EXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#why-would-i-use-exp-rather-than-pyexp">Why would I use EXP rather than pyEXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#what-hardware-do-i-need-to-run-exp-and-pyexp">What hardware do I need to run EXP and pyEXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#how-do-i-restart-exp-from-a-checkpoint">How do I restart EXP from a checkpoint?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#my-hpc-cluster-does-not-have-the-required-dependencies-what-are-my-options">My HPC cluster does not have the required dependencies.  What are my options?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#can-i-run-exp-or-pyexp-in-a-container">Can I run EXP or pyEXP in a container?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#i-got-a-seg-fault-now-what-do-i-do">I got a “seg fault”, now what do I do?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#how-can-i-do-a-calculation-with-phase-space-in-pyexp">How can I do a calculation with phase space in pyEXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq.html#what-do-these-parameters-mean">What do these parameters mean?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How to solve specific problems</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/visualizing-bases.html">How to visualize the BFE bases used to make your coefficients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/making-coefficients.html">How to  generate coefficients from phase-space snapshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/saving-coefficients.html">How to save and reuse your newly generated coefficients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/visualizing-fields.html">How to convert your coefficients back to physical fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/make-movies.html">Making movies of your BFE field quantities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/using-mssa.html">How to use mSSA with your coefficient series in pyEXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/orbits.html">Generating orbits in your BFE potential fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/replay.html">Replaying a simulation using EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/exp-phase-space.html">The EXP phase-space format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/EXP-output.html">How the EXP N-body code selects what and when to write data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/flatdisk.html">How to configure a razor-thin disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/debug.html">Debugging EXP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending EXP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/design.html">Software design goals and features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/design.html#overall-organization-of-the-code">Overall organization of the code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/design.html#parallel-usage">Parallel usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/usermodules.html">User modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../topics/newforces.html">How to make a new EXP force</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More about EXP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../news.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributing to EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doxygen.html">Index to C++ classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pybind11.html">Index to pyEXP classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../versioning.html">Versioning and API stability</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">EXP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Functions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/exp_repo/extern/pybind11/docs/advanced/functions.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="functions">
<h1>Functions<a class="headerlink" href="#functions" title="Link to this heading"></a></h1>
<p>Before proceeding with this section, make sure that you are already familiar
with the basics of binding functions and classes, as explained in <span class="xref std std-doc">/basics</span>
and <span class="xref std std-doc">/classes</span>. The following guide is applicable to both free and member
functions, i.e. <em>methods</em> in Python.</p>
<section id="return-value-policies">
<span id="id1"></span><h2>Return value policies<a class="headerlink" href="#return-value-policies" title="Link to this heading"></a></h2>
<p>Python and C++ use fundamentally different ways of managing the memory and
lifetime of objects managed by them. This can lead to issues when creating
bindings for functions that return a non-trivial type. Just by looking at the
type information, it is not clear whether Python should take charge of the
returned value and eventually free its resources, or if this is handled on the
C++ side. For this reason, pybind11 provides several <em>return value policy</em>
annotations that can be passed to the <code class="xref py py-func docutils literal notranslate"><span class="pre">module_::def()</span></code> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">class_::def()</span></code> functions. The default policy is
<a href="#id2"><span class="problematic" id="id3">:enum:`return_value_policy::automatic`</span></a>.</p>
<p>Return value policies are tricky, and it’s very important to get them right.
Just to illustrate what can go wrong, consider the following simple example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Function declaration */</span>
<span class="n">Data</span><span class="w"> </span><span class="o">*</span><span class="nf">get_data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_data</span><span class="p">;</span><span class="w"> </span><span class="cm">/* (pointer to a static data structure) */</span><span class="w"> </span><span class="p">}</span>
<span class="p">...</span>

<span class="cm">/* Binding code */</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;get_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">get_data</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;-- KABOOM, will cause crash when called from Python</span>
</pre></div>
</div>
<p>What’s going on here? When <code class="docutils literal notranslate"><span class="pre">get_data()</span></code> is called from Python, the return
value (a native C++ type) must be wrapped to turn it into a usable Python type.
In this case, the default return value policy (<a href="#id4"><span class="problematic" id="id5">:enum:`return_value_policy::automatic`</span></a>)
causes pybind11 to assume ownership of the static <code class="docutils literal notranslate"><span class="pre">_data</span></code> instance.</p>
<p>When Python’s garbage collector eventually deletes the Python
wrapper, pybind11 will also attempt to delete the C++ instance (via <code class="docutils literal notranslate"><span class="pre">operator</span>
<span class="pre">delete()</span></code>) due to the implied ownership. At this point, the entire application
will come crashing down, though errors could also be more subtle and involve
silent data corruption.</p>
<p>In the above example, the policy <a href="#id6"><span class="problematic" id="id7">:enum:`return_value_policy::reference`</span></a> should have
been specified so that the global data instance is only <em>referenced</em> without any
implied transfer of ownership, i.e.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;get_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">get_data</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">return_value_policy</span><span class="o">::</span><span class="n">reference</span><span class="p">);</span>
</pre></div>
</div>
<p>On the other hand, this is not the right policy for many other situations,
where ignoring ownership could lead to resource leaks.
As a developer using pybind11, it’s important to be familiar with the different
return value policies, including which situation calls for which one of them.
The following table provides an overview of available policies:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Return value policy</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a href="#id8"><span class="problematic" id="id9">:enum:`return_value_policy::take_ownership`</span></a></p></td>
<td><p>Reference an existing object (i.e. do not create a new copy) and take
ownership. Python will call the destructor and delete operator when the
object’s reference count reaches zero. Undefined behavior ensues when the
C++ side does the same, or when the data was not dynamically allocated.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id10"><span class="problematic" id="id11">:enum:`return_value_policy::copy`</span></a></p></td>
<td><p>Create a new copy of the returned object, which will be owned by Python.
This policy is comparably safe because the lifetimes of the two instances
are decoupled.</p></td>
</tr>
<tr class="row-even"><td><p><a href="#id12"><span class="problematic" id="id13">:enum:`return_value_policy::move`</span></a></p></td>
<td><p>Use <code class="docutils literal notranslate"><span class="pre">std::move</span></code> to move the return value contents into a new instance
that will be owned by Python. This policy is comparably safe because the
lifetimes of the two instances (move source and destination) are decoupled.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id14"><span class="problematic" id="id15">:enum:`return_value_policy::reference`</span></a></p></td>
<td><p>Reference an existing object, but do not take ownership. The C++ side is
responsible for managing the object’s lifetime and deallocating it when
it is no longer used. Warning: undefined behavior will ensue when the C++
side deletes an object that is still referenced and used by Python.</p></td>
</tr>
<tr class="row-even"><td><p><a href="#id16"><span class="problematic" id="id17">:enum:`return_value_policy::reference_internal`</span></a></p></td>
<td><p>Indicates that the lifetime of the return value is tied to the lifetime
of a parent object, namely the implicit <code class="docutils literal notranslate"><span class="pre">this</span></code>, or <code class="docutils literal notranslate"><span class="pre">self</span></code> argument of
the called method or property. Internally, this policy works just like
<a href="#id18"><span class="problematic" id="id19">:enum:`return_value_policy::reference`</span></a> but additionally applies a
<code class="docutils literal notranslate"><span class="pre">keep_alive&lt;0,</span> <span class="pre">1&gt;</span></code> <em>call policy</em> (described in the next section) that
prevents the parent object from being garbage collected as long as the
return value is referenced by Python. This is the default policy for
property getters created via <code class="docutils literal notranslate"><span class="pre">def_property</span></code>, <code class="docutils literal notranslate"><span class="pre">def_readwrite</span></code>, etc.</p></td>
</tr>
<tr class="row-odd"><td><p><a href="#id20"><span class="problematic" id="id21">:enum:`return_value_policy::automatic`</span></a></p></td>
<td><p>This policy falls back to the policy
<a href="#id22"><span class="problematic" id="id23">:enum:`return_value_policy::take_ownership`</span></a> when the return value is a
pointer. Otherwise, it uses <a href="#id24"><span class="problematic" id="id25">:enum:`return_value_policy::move`</span></a> or
<a href="#id26"><span class="problematic" id="id27">:enum:`return_value_policy::copy`</span></a> for rvalue and lvalue references,
respectively. See above for a description of what all of these different
policies do. This is the default policy for <code class="docutils literal notranslate"><span class="pre">py::class_</span></code>-wrapped types.</p></td>
</tr>
<tr class="row-even"><td><p><a href="#id28"><span class="problematic" id="id29">:enum:`return_value_policy::automatic_reference`</span></a></p></td>
<td><p>As above, but use policy <a href="#id30"><span class="problematic" id="id31">:enum:`return_value_policy::reference`</span></a> when the
return value is a pointer. This is the default conversion policy for
function arguments when calling Python functions manually from C++ code
(i.e. via <code class="docutils literal notranslate"><span class="pre">handle::operator()</span></code>) and the casters in <code class="docutils literal notranslate"><span class="pre">pybind11/stl.h</span></code>.
You probably won’t need to use this explicitly.</p></td>
</tr>
</tbody>
</table>
<p>Return value policies can also be applied to properties:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">class_</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def_property</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">getData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">setData</span><span class="p">,</span>
<span class="w">                  </span><span class="n">py</span><span class="o">::</span><span class="n">return_value_policy</span><span class="o">::</span><span class="n">copy</span><span class="p">);</span>
</pre></div>
</div>
<p>Technically, the code above applies the policy to both the getter and the
setter function, however, the setter doesn’t really care about <em>return</em>
value policies which makes this a convenient terse syntax. Alternatively,
targeted arguments can be passed through the <code class="xref py py-class docutils literal notranslate"><span class="pre">cpp_function</span></code> constructor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">class_</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def_property</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">cpp_function</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">getData</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">return_value_policy</span><span class="o">::</span><span class="n">copy</span><span class="p">),</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">cpp_function</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">setData</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Code with invalid return value policies might access uninitialized memory or
free data structures multiple times, which can lead to hard-to-debug
non-determinism and segmentation faults, hence it is worth spending the
time to understand all the different options in the table above.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One important aspect of the above policies is that they only apply to
instances which pybind11 has <em>not</em> seen before, in which case the policy
clarifies essential questions about the return value’s lifetime and
ownership.  When pybind11 knows the instance already (as identified by its
type and address in memory), it will return the existing Python object
wrapper rather than creating a new copy.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The next section on <a class="reference internal" href="#call-policies"><span class="std std-ref">Additional call policies</span></a> discusses <em>call policies</em> that can be
specified <em>in addition</em> to a return value policy from the list above. Call
policies indicate reference relationships that can involve both return values
and parameters of functions.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As an alternative to elaborate call policies and lifetime management logic,
consider using smart pointers (see the section on <a class="reference internal" href="smart_ptrs.html#id1"><span class="std std-ref">Custom smart pointers</span></a> for
details). Smart pointers can tell whether an object is still referenced from
C++ or Python, which generally eliminates the kinds of inconsistencies that
can lead to crashes or undefined behavior. For functions returning smart
pointers, it is not necessary to specify a return value policy.</p>
</div>
</section>
<section id="additional-call-policies">
<span id="call-policies"></span><h2>Additional call policies<a class="headerlink" href="#additional-call-policies" title="Link to this heading"></a></h2>
<p>In addition to the above return value policies, further <em>call policies</em> can be
specified to indicate dependencies between parameters or ensure a certain state
for the function call.</p>
<section id="keep-alive">
<h3>Keep alive<a class="headerlink" href="#keep-alive" title="Link to this heading"></a></h3>
<p>In general, this policy is required when the C++ object is any kind of container
and another object is being added to the container. <code class="docutils literal notranslate"><span class="pre">keep_alive&lt;Nurse,</span> <span class="pre">Patient&gt;</span></code>
indicates that the argument with index <code class="docutils literal notranslate"><span class="pre">Patient</span></code> should be kept alive at least
until the argument with index <code class="docutils literal notranslate"><span class="pre">Nurse</span></code> is freed by the garbage collector. Argument
indices start at one, while zero refers to the return value. For methods, index
<code class="docutils literal notranslate"><span class="pre">1</span></code> refers to the implicit <code class="docutils literal notranslate"><span class="pre">this</span></code> pointer, while regular arguments begin at
index <code class="docutils literal notranslate"><span class="pre">2</span></code>. Arbitrarily many call policies can be specified. When a <code class="docutils literal notranslate"><span class="pre">Nurse</span></code>
with value <code class="docutils literal notranslate"><span class="pre">None</span></code> is detected at runtime, the call policy does nothing.</p>
<p>When the nurse is not a pybind11-registered type, the implementation internally
relies on the ability to create a <em>weak reference</em> to the nurse object. When
the nurse object is not a pybind11-registered type and does not support weak
references, an exception will be thrown.</p>
<p>If you use an incorrect argument index, you will get a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> saying
<code class="docutils literal notranslate"><span class="pre">Could</span> <span class="pre">not</span> <span class="pre">activate</span> <span class="pre">keep_alive!</span></code>. You should review the indices you’re using.</p>
<p>Consider the following example: here, the binding code for a list append
operation ties the lifetime of the newly added element to the underlying
container:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;List&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;append&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">List</span><span class="o">::</span><span class="n">append</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">keep_alive</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="p">());</span>
</pre></div>
</div>
<p>For consistency, the argument indexing is identical for constructors. Index
<code class="docutils literal notranslate"><span class="pre">1</span></code> still refers to the implicit <code class="docutils literal notranslate"><span class="pre">this</span></code> pointer, i.e. the object which is
being constructed. Index <code class="docutils literal notranslate"><span class="pre">0</span></code> refers to the return type which is presumed to
be <code class="docutils literal notranslate"><span class="pre">void</span></code> when a constructor is viewed like a function. The following example
ties the lifetime of the constructor element to the constructed object:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">Nurse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Nurse&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;</span><span class="n">Patient</span><span class="w"> </span><span class="o">&amp;&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">keep_alive</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="p">());</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">keep_alive</span></code> is analogous to the <code class="docutils literal notranslate"><span class="pre">with_custodian_and_ward</span></code> (if Nurse,
Patient != 0) and <code class="docutils literal notranslate"><span class="pre">with_custodian_and_ward_postcall</span></code> (if Nurse/Patient ==
0) policies from Boost.Python.</p>
</div>
</section>
<section id="call-guard">
<h3>Call guard<a class="headerlink" href="#call-guard" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">call_guard&lt;T&gt;</span></code> policy allows any scope guard type <code class="docutils literal notranslate"><span class="pre">T</span></code> to be placed
around the function call. For example, this definition:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">call_guard</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">());</span>
</pre></div>
</div>
<p>is equivalent to the following pseudocode:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">args</span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">scope_guard</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span><span class="w"> </span><span class="c1">// forwarded arguments</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The only requirement is that <code class="docutils literal notranslate"><span class="pre">T</span></code> is default-constructible, but otherwise any
scope guard will work. This is very useful in combination with <code class="docutils literal notranslate"><span class="pre">gil_scoped_release</span></code>.
See <a class="reference internal" href="misc.html#gil"><span class="std std-ref">Global Interpreter Lock (GIL)</span></a>.</p>
<p>Multiple guards can also be specified as <code class="docutils literal notranslate"><span class="pre">py::call_guard&lt;T1,</span> <span class="pre">T2,</span> <span class="pre">T3...&gt;</span></code>. The
constructor order is left to right and destruction happens in reverse.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>The file <code class="file docutils literal notranslate"><span class="pre">tests/test_call_policies.cpp</span></code> contains a complete example
that demonstrates using <cite>keep_alive</cite> and <cite>call_guard</cite> in more detail.</p>
</div>
</section>
</section>
<section id="python-objects-as-arguments">
<span id="python-objects-as-args"></span><h2>Python objects as arguments<a class="headerlink" href="#python-objects-as-arguments" title="Link to this heading"></a></h2>
<p>pybind11 exposes all major Python types using thin C++ wrapper classes. These
wrapper classes can also be used as parameters of functions in bindings, which
makes it possible to directly work with native Python types on the C++ side.
For instance, the following statement iterates over a Python <code class="docutils literal notranslate"><span class="pre">dict</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">print_dict</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="o">&amp;</span><span class="w"> </span><span class="n">dict</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Easily interact with Python types */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dict</span><span class="p">)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;key=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It can be exported:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;print_dict&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">print_dict</span><span class="p">);</span>
</pre></div>
</div>
<p>And used in Python as usual:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print_dict</span><span class="p">({</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">})</span>
<span class="go">key=foo, value=123</span>
<span class="go">key=bar, value=hello</span>
</pre></div>
</div>
<p>For more information on using Python objects in C++, see <span class="xref std std-doc">/advanced/pycpp/index</span>.</p>
</section>
<section id="accepting-args-and-kwargs">
<h2>Accepting *args and **kwargs<a class="headerlink" href="#accepting-args-and-kwargs" title="Link to this heading"></a></h2>
<p>Python provides a useful mechanism to define functions that accept arbitrary
numbers of arguments and keyword arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generic</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="o">...</span>  <span class="c1"># do something with args and kwargs</span>
</pre></div>
</div>
<p>Such functions can also be created using pybind11:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">generic</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">args</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">kwargs</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kwargs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">/// .. do something with args</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<span class="w">        </span><span class="c1">/// .. do something with kwargs</span>
<span class="p">}</span>

<span class="c1">/// Binding code</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;generic&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">generic</span><span class="p">);</span>
</pre></div>
</div>
<p>The class <code class="docutils literal notranslate"><span class="pre">py::args</span></code> derives from <code class="docutils literal notranslate"><span class="pre">py::tuple</span></code> and <code class="docutils literal notranslate"><span class="pre">py::kwargs</span></code> derives
from <code class="docutils literal notranslate"><span class="pre">py::dict</span></code>.</p>
<p>You may also use just one or the other, and may combine these with other
arguments.  Note, however, that <code class="docutils literal notranslate"><span class="pre">py::kwargs</span></code> must always be the last argument
of the function, and <code class="docutils literal notranslate"><span class="pre">py::args</span></code> implies that any further arguments are
keyword-only (see <a class="reference internal" href="#keyword-only-arguments"><span class="std std-ref">Keyword-only arguments</span></a>).</p>
<p>Please refer to the other examples for details on how to iterate over these,
and on how to cast their entries into C++ objects. A demonstration is also
available in <code class="docutils literal notranslate"><span class="pre">tests/test_kwargs_and_defaults.cpp</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When combining *args or **kwargs with <a class="reference internal" href="../basics.html#keyword-args"><span class="std std-ref">Keyword arguments</span></a> you should
<em>not</em> include <code class="docutils literal notranslate"><span class="pre">py::arg</span></code> tags for the <code class="docutils literal notranslate"><span class="pre">py::args</span></code> and <code class="docutils literal notranslate"><span class="pre">py::kwargs</span></code>
arguments.</p>
</div>
</section>
<section id="default-arguments-revisited">
<h2>Default arguments revisited<a class="headerlink" href="#default-arguments-revisited" title="Link to this heading"></a></h2>
<p>The section on <a class="reference internal" href="../basics.html#default-args"><span class="std std-ref">Default arguments</span></a> previously discussed basic usage of default
arguments using pybind11. One noteworthy aspect of their implementation is that
default arguments are converted to Python objects right at declaration time.
Consider the following example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;myFunction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;arg&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeType</span><span class="p">(</span><span class="mi">123</span><span class="p">));</span>
</pre></div>
</div>
<p>In this case, pybind11 must already be set up to deal with values of the type
<code class="docutils literal notranslate"><span class="pre">SomeType</span></code> (via a prior instantiation of <code class="docutils literal notranslate"><span class="pre">py::class_&lt;SomeType&gt;</span></code>), or an
exception will be thrown.</p>
<p>Another aspect worth highlighting is that the “preview” of the default argument
in the function signature is generated using the object’s <code class="docutils literal notranslate"><span class="pre">__repr__</span></code> method.
If not available, the signature may not be very helpful, e.g.:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go">FUNCTIONS</span>
<span class="go">...</span>
<span class="go">|  myFunction(...)</span>
<span class="go">|      Signature : (MyClass, arg : SomeType = &lt;SomeType object at 0x101b7b080&gt;) -&gt; NoneType</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The first way of addressing this is by defining <code class="docutils literal notranslate"><span class="pre">SomeType.__repr__</span></code>.
Alternatively, it is possible to specify the human-readable preview of the
default argument manually using the <code class="docutils literal notranslate"><span class="pre">arg_v</span></code> notation:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;myFunction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg_v</span><span class="p">(</span><span class="s">&quot;arg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SomeType</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;SomeType(123)&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Sometimes it may be necessary to pass a null pointer value as a default
argument. In this case, remember to cast it to the underlying type in question,
like so:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;myFunction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;arg&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">SomeType</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="k">nullptr</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="keyword-only-arguments">
<span id="id32"></span><h2>Keyword-only arguments<a class="headerlink" href="#keyword-only-arguments" title="Link to this heading"></a></h2>
<p>Python implements keyword-only arguments by specifying an unnamed <code class="docutils literal notranslate"><span class="pre">*</span></code>
argument in a function definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># a can be positional or via keyword; b must be via keyword</span>
    <span class="k">pass</span>


<span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># good</span>
<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># good</span>
<span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># good</span>
<span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># TypeError: f() takes 1 positional argument but 2 were given</span>
</pre></div>
</div>
<p>Pybind11 provides a <code class="docutils literal notranslate"><span class="pre">py::kw_only</span></code> object that allows you to implement
the same behaviour by specifying the object between positional and keyword-only
argument annotations when registering the function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">kw_only</span><span class="p">(),</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">));</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.6.</span></p>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">py::args</span></code> argument implies that any following arguments are keyword-only,
as if <code class="docutils literal notranslate"><span class="pre">py::kw_only()</span></code> had been specified in the same relative location of the
argument list as the <code class="docutils literal notranslate"><span class="pre">py::args</span></code> argument.  The <code class="docutils literal notranslate"><span class="pre">py::kw_only()</span></code> may be
included to be explicit about this, but is not required.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.9: </span>This can now be combined with <code class="docutils literal notranslate"><span class="pre">py::args</span></code>. Before, <code class="docutils literal notranslate"><span class="pre">py::args</span></code> could only
occur at the end of the argument list, or immediately before a <code class="docutils literal notranslate"><span class="pre">py::kwargs</span></code>
argument at the end.</p>
</div>
</section>
<section id="positional-only-arguments">
<h2>Positional-only arguments<a class="headerlink" href="#positional-only-arguments" title="Link to this heading"></a></h2>
<p>Python 3.8 introduced a new positional-only argument syntax, using <code class="docutils literal notranslate"><span class="pre">/</span></code> in the
function definition (note that this has been a convention for CPython
positional arguments, such as in <code class="docutils literal notranslate"><span class="pre">pow()</span></code>, since Python 2). You can
do the same thing in any version of Python using <code class="docutils literal notranslate"><span class="pre">py::pos_only()</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">},</span>
<span class="w">       </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">pos_only</span><span class="p">(),</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>You now cannot give argument <code class="docutils literal notranslate"><span class="pre">a</span></code> by keyword. This can be combined with
keyword-only arguments, as well.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.6.</span></p>
</div>
</section>
<section id="non-converting-arguments">
<span id="nonconverting-arguments"></span><h2>Non-converting arguments<a class="headerlink" href="#non-converting-arguments" title="Link to this heading"></a></h2>
<p>Certain argument types may support conversion from one type to another.  Some
examples of conversions are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="classes.html#implicit-conversions"><span class="std std-ref">Implicit conversions</span></a> declared using <code class="docutils literal notranslate"><span class="pre">py::implicitly_convertible&lt;A,B&gt;()</span></code></p></li>
<li><p>Calling a method accepting a double with an integer argument</p></li>
<li><p>Calling a <code class="docutils literal notranslate"><span class="pre">std::complex&lt;float&gt;</span></code> argument with a non-complex python type
(for example, with a float).  (Requires the optional <code class="docutils literal notranslate"><span class="pre">pybind11/complex.h</span></code>
header).</p></li>
<li><p>Calling a function taking an Eigen matrix reference with a numpy array of the
wrong type or of an incompatible data layout.  (Requires the optional
<code class="docutils literal notranslate"><span class="pre">pybind11/eigen.h</span></code> header).</p></li>
</ul>
<p>This behaviour is sometimes undesirable: the binding code may prefer to raise
an error rather than convert the argument.  This behaviour can be obtained
through <code class="docutils literal notranslate"><span class="pre">py::arg</span></code> by calling the <code class="docutils literal notranslate"><span class="pre">.noconvert()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">py::arg</span></code>
object, such as:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;floats_only&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">double</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">).</span><span class="n">noconvert</span><span class="p">());</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;floats_preferred&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="kt">double</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Attempting the call the second function (the one without <code class="docutils literal notranslate"><span class="pre">.noconvert()</span></code>) with
an integer will succeed, but attempting to call the <code class="docutils literal notranslate"><span class="pre">.noconvert()</span></code> version
will fail with a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">floats_preferred</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="go">2.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">floats_only</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">floats_only(): incompatible function arguments. The following argument types are supported:</span>
<span class="x">    1. (f: float) -&gt; float</span>

<span class="x">Invoked with: 4</span>
</pre></div>
</div>
<p>You may, of course, combine this with the <a href="#id33"><span class="problematic" id="id34">:var:`_a`</span></a> shorthand notation (see
<a class="reference internal" href="../basics.html#keyword-args"><span class="std std-ref">Keyword arguments</span></a>) and/or <a class="reference internal" href="../basics.html#default-args"><span class="std std-ref">Default arguments</span></a>.  It is also permitted to omit
the argument name by using the <code class="docutils literal notranslate"><span class="pre">py::arg()</span></code> constructor without an argument
name, i.e. by specifying <code class="docutils literal notranslate"><span class="pre">py::arg().noconvert()</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When specifying <code class="docutils literal notranslate"><span class="pre">py::arg</span></code> options it is necessary to provide the same
number of options as the bound function has arguments.  Thus if you want to
enable no-convert behaviour for just one of several arguments, you will
need to specify a <code class="docutils literal notranslate"><span class="pre">py::arg()</span></code> annotation for each argument with the
no-convert argument modified to <code class="docutils literal notranslate"><span class="pre">py::arg().noconvert()</span></code>.</p>
</div>
</section>
<section id="allow-prohibiting-none-arguments">
<span id="none-arguments"></span><h2>Allow/Prohibiting None arguments<a class="headerlink" href="#allow-prohibiting-none-arguments" title="Link to this heading"></a></h2>
<p>When a C++ type registered with <code class="xref py py-class docutils literal notranslate"><span class="pre">py::class_</span></code> is passed as an argument to
a function taking the instance as pointer or shared holder (e.g. <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>
or a custom, copyable holder as described in <a class="reference internal" href="smart_ptrs.html#id1"><span class="std std-ref">Custom smart pointers</span></a>), pybind
allows <code class="docutils literal notranslate"><span class="pre">None</span></code> to be passed from Python which results in calling the C++
function with <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> (or an empty holder) for the argument.</p>
<p>To explicitly enable or disable this behaviour, using the
<code class="docutils literal notranslate"><span class="pre">.none</span></code> method of the <code class="xref py py-class docutils literal notranslate"><span class="pre">py::arg</span></code> object:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">Dog</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span><span class="p">).</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">).</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;bark&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">Dog</span><span class="w"> </span><span class="o">*</span><span class="n">dog</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dog</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;woof!&quot;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Called with a Dog instance */</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;(no dog)&quot;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Called with None, dog == nullptr */</span>
<span class="p">},</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;dog&quot;</span><span class="p">).</span><span class="n">none</span><span class="p">(</span><span class="nb">true</span><span class="p">));</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;meow&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">Cat</span><span class="w"> </span><span class="o">*</span><span class="n">cat</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Can&#39;t be called with None argument</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;meow&quot;</span><span class="p">;</span>
<span class="p">},</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;cat&quot;</span><span class="p">).</span><span class="n">none</span><span class="p">(</span><span class="nb">false</span><span class="p">));</span>
</pre></div>
</div>
<p>With the above, the Python call <code class="docutils literal notranslate"><span class="pre">bark(None)</span></code> will return the string <code class="docutils literal notranslate"><span class="pre">&quot;(no</span>
<span class="pre">dog)&quot;</span></code>, while attempting to call <code class="docutils literal notranslate"><span class="pre">meow(None)</span></code> will raise a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">animals</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dog</span><span class="p">,</span> <span class="n">Cat</span><span class="p">,</span> <span class="n">bark</span><span class="p">,</span> <span class="n">meow</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bark</span><span class="p">(</span><span class="n">Dog</span><span class="p">())</span>
<span class="go">&#39;woof!&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">meow</span><span class="p">(</span><span class="n">Cat</span><span class="p">())</span>
<span class="go">&#39;meow&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bark</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="go">&#39;(no dog)&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">meow</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">meow(): incompatible function arguments. The following argument types are supported:</span>
<span class="x">    1. (cat: animals.Cat) -&gt; str</span>

<span class="x">Invoked with: None</span>
</pre></div>
</div>
<p>The default behaviour when the tag is unspecified is to allow <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even when <code class="docutils literal notranslate"><span class="pre">.none(true)</span></code> is specified for an argument, <code class="docutils literal notranslate"><span class="pre">None</span></code> will be converted to a
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code> <em>only</em> for custom and <a class="reference internal" href="cast/stl.html#opaque"><span class="std std-ref">opaque</span></a> types. Pointers to built-in types
(<code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">*</span></code>, …) and STL types (<code class="docutils literal notranslate"><span class="pre">std::vector&lt;T&gt;</span> <span class="pre">*</span></code>, …; if <code class="docutils literal notranslate"><span class="pre">pybind11/stl.h</span></code>
is included) are copied when converted to C++ (see <span class="xref std std-doc">/advanced/cast/overview</span>) and will
not allow <code class="docutils literal notranslate"><span class="pre">None</span></code> as argument.  To pass optional argument of these copied types consider
using <code class="docutils literal notranslate"><span class="pre">std::optional&lt;T&gt;</span></code></p>
</div>
</section>
<section id="overload-resolution-order">
<span id="overload-resolution"></span><h2>Overload resolution order<a class="headerlink" href="#overload-resolution-order" title="Link to this heading"></a></h2>
<p>When a function or method with multiple overloads is called from Python,
pybind11 determines which overload to call in two passes.  The first pass
attempts to call each overload without allowing argument conversion (as if
every argument had been specified as <code class="docutils literal notranslate"><span class="pre">py::arg().noconvert()</span></code> as described
above).</p>
<p>If no overload succeeds in the no-conversion first pass, a second pass is
attempted in which argument conversion is allowed (except where prohibited via
an explicit <code class="docutils literal notranslate"><span class="pre">py::arg().noconvert()</span></code> attribute in the function definition).</p>
<p>If the second pass also fails a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> is raised.</p>
<p>Within each pass, overloads are tried in the order they were registered with
pybind11. If the <code class="docutils literal notranslate"><span class="pre">py::prepend()</span></code> tag is added to the definition, a function
can be placed at the beginning of the overload sequence instead, allowing user
overloads to proceed built in functions.</p>
<p>What this means in practice is that pybind11 will prefer any overload that does
not require conversion of arguments to an overload that does, but otherwise
prefers earlier-defined overloads to later-defined ones.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>pybind11 does <em>not</em> further prioritize based on the number/pattern of
overloaded arguments.  That is, pybind11 does not prioritize a function
requiring one conversion over one requiring three, but only prioritizes
overloads requiring no conversion at all to overloads that require
conversion of at least one argument.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.6: </span>The <code class="docutils literal notranslate"><span class="pre">py::prepend()</span></code> tag.</p>
</div>
</section>
<section id="binding-functions-with-template-parameters">
<h2>Binding functions with template parameters<a class="headerlink" href="#binding-functions-with-template-parameters" title="Link to this heading"></a></h2>
<p>You can bind functions that have template parameters. Here’s a function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">set</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
</pre></div>
</div>
<p>C++ templates cannot be instantiated at runtime, so you cannot bind the
non-instantiated function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// BROKEN (this will not compile)</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
</pre></div>
</div>
<p>You must bind each instantiated function template separately. You may bind
each instantiation with the same name, which will be treated the same as
an overloaded function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">);</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>Sometimes it’s more clear to bind them with separate names, which is also
an option:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;setInt&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">);</span>
<span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;setString&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2025, EXP-code collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>