<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User modules &mdash; EXP 0.172 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=9c6809b7"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=5eb1bb1e"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to make a new EXP force" href="newforces.html" />
    <link rel="prev" title="Software design goals and features" href="design.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            EXP
              <img src="../_static/exp_logo_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                7.x
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">First steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/overview.html">EXP at a glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/install.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/tutorial.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">EXP concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bfetheory.html">BFE theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="codeintro.html">Code intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="timesseries.html">BFE time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units in EXP and pyEXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="multistep.html">N-Body optimization in EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="centering.html">Centering</a></li>
<li class="toctree-l1"><a class="reference internal" href="yamlconfig.html">What is YAML?</a></li>
<li class="toctree-l1"><a class="reference internal" href="yamlconfig.html#an-annotated-exp-yaml-configuration">An annotated EXP YAML configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtosim.html">How to run your own N-body simulation in EXP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions (FAQ)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Are there pre-compiled versions of pyEXP and EXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#i-only-want-pyexp-do-i-need-c-to-compile-exp">I only want pyEXP, do I need C++ to compile EXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#why-would-i-use-exp-rather-than-pyexp">Why would I use EXP rather than pyEXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#what-hardware-do-i-need-to-run-exp-and-pyexp">What hardware do I need to run EXP and pyEXP?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#how-do-i-restart-exp-from-a-checkpoint">How do I restart EXP from a checkpoint?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#my-hpc-cluster-does-not-have-the-required-dependencies-what-are-my-options">My HPC cluster does not have the required dependencies.  What are my options?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#can-i-run-exp-or-pyexp-in-a-container">Can I run EXP or pyEXP in a container?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#i-got-a-seg-fault-now-what-do-i-do">I got a “seg fault”, now what do I do?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#how-can-i-do-a-calculation-with-phase-space-in-pyexp">How can I do a calculation with phase space in pyEXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html#what-do-these-parameters-mean">What do these parameters mean?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How to solve specific problems</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="visualizing-bases.html">How to visualize the BFE bases used to make your coefficients</a></li>
<li class="toctree-l1"><a class="reference internal" href="making-coefficients.html">How to  generate coefficients from phase-space snapshots</a></li>
<li class="toctree-l1"><a class="reference internal" href="saving-coefficients.html">How to save and reuse your newly generated coefficients</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualizing-fields.html">How to convert your coefficients back to physical fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="make-movies.html">Making movies of your BFE field quantities</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-mssa.html">How to use mSSA with your coefficient series in pyEXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="orbits.html">Generating orbits in your BFE potential fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="replay.html">Replaying a simulation using EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="exp-phase-space.html">The EXP phase-space format</a></li>
<li class="toctree-l1"><a class="reference internal" href="EXP-output.html">How the EXP N-body code selects what and when to write data</a></li>
<li class="toctree-l1"><a class="reference internal" href="flatdisk.html">How to configure a razor-thin disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Debugging EXP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending EXP</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="design.html">Software design goals and features</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html#overall-organization-of-the-code">Overall organization of the code</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html#parallel-usage">Parallel usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#extending-src-user">Extending <cite>src/user</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#notes-on-writing-your-module">Notes on writing your module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-a-private-repository-for-your-modules">Using a private repository for your modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="newforces.html">How to make a new EXP force</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More about EXP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../news.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to EXP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">Index to C++ classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pybind11.html">Index to pyEXP classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versioning.html">Versioning and API stability</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">EXP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">User modules</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/topics/usermodules.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="user-modules">
<span id="usermodules"></span><h1>User modules<a class="headerlink" href="#user-modules" title="Link to this heading"></a></h1>
<p>Users may write modules that are found and loaded at run time.  One may
derive classes from <cite>ExternalForce</cite> that may be built as
dynamic modules that may be loaded and instantiated as needed.
Modules are built in the <cite>src/user</cite> directory.  This is
accomplished using dynamically loaded (DL) libraries that register
themselves on a list of <cite>ExternalForce</cite> instances that may be
instantiated as directed in your configuration file.  These new
modules have access to the entire phase space for each component.  It
is the user’s responsibility to not change the phase space in
unphysical ways, of course.</p>
<p>We offer two strategies for incorporating your user modules into EXP:</p>
<ol class="arabic simple">
<li><p>Extend the <cite>CMakeLists.txt</cite> file in <cite>src/user</cite> to build and install
your source in EXP.  You can keep your code private in a local
branch or a fork.  This is described in <a class="reference internal" href="#module-branch"><span class="std std-ref">Extending</span></a> below.</p></li>
<li><p>Create a private git repository and use the submodule facility in
git to build the source and install the source in EXP.  This is
described in <a class="reference internal" href="#module-private"><span class="std std-ref">Using a private repo</span></a>.</p></li>
</ol>
<section id="extending-src-user">
<h2>Extending <cite>src/user</cite><a class="headerlink" href="#extending-src-user" title="Link to this heading"></a></h2>
<p id="module-branch">There are only a few steps necessary to put one’s code in the tree:</p>
<ol class="arabic simple">
<li><p>Write the code (see below for additional details)</p></li>
<li><p>Edit <cite>CMakeLists.txt</cite>.  Assume you module is called
<cite>foo</cite> and is implemented in the following source files
<cite>foo1.cc</cite> and <cite>foo2.cc</cite>. Do the following:</p>
<ul class="simple">
<li><p>Define a new source variable pointing to the source files in the
<cite>CMakeLists.txt</cite>.  E.g.  <cite>set(foo_SRC foo1.cc foo2.cc)</cite></p></li>
</ul>
</li>
<li><p>Compile the code</p></li>
<li><p>Install the code in the location defined by your configuration</p></li>
</ol>
<section id="notes-on-writing-your-module">
<h3>Notes on writing your module<a class="headerlink" href="#notes-on-writing-your-module" title="Link to this heading"></a></h3>
<p>A good place to start is the code already in the <cite>src/user</cite>
directory. The simplest code is <cite>UserTest.cc</cite>; this does
nothing but print messages but illustrates all of the necessary
components.</p>
<p>All classes, of course, must derive from <cite>ExternalForce</cite>.  A quick
look at <cite>src/ExternalForce.H</cite> will show that you will need to
implement at least the member
<cite>determine_acceleration_and_potential_thread()</cite>.  In order to parse
command line parameters, you will also need a constructor and
<cite>initialize()</cite> and maybe a destructor.</p>
<p>In addition, there is a mechanism that identifies your new class to
EXP.  This has two parts.  First you must define a C
function which constructs an instance of your class and returns a
pointer. Using the C calling interface here gets around the problem of
name demangling in C++ in using the dynamic linking loader (there may
be a more transparent and portable way to do this).  You will notice
an additional class at the end of the file called <cite>proxy</cite>.  An
instance of this simple class is instantiated when the module is
loaded (the last line in the file).  As a byproduct, a pointer to the
function <cite>makeTest()</cite> is is added to the factory map defined in
<cite>ExternalForce.H</cite>.  This function can then be invoked by name
in the code to create an instance of your class.  Cute trick, eh?  You
can simply copy this to your own source (changing <cite>makerTest</cite>
to <cite>makerFoo</cite> or some other unique name).</p>
</section>
</section>
<section id="using-a-private-repository-for-your-modules">
<h2>Using a private repository for your modules<a class="headerlink" href="#using-a-private-repository-for-your-modules" title="Link to this heading"></a></h2>
<p id="module-private">The strategy above describes adding your module directly to the
<cite>src/user</cite> directory. With this workflow, you would keep a personal
branch and merge new changes from the <cite>main</cite> EXP branch as they become
available.</p>
<p>We support an additional strategy that allows you to work directly
from the <cite>main</cite> EXP repo without a private local branch or a fork.  In
this alternative scenario, you would make a private git repository,
either on your local machine or git server (e.g. GitHub) and install
your repository in the <cite>extern/user-modules</cite> directory.  This steps
for this are:</p>
<ol class="arabic simple">
<li><p>Copy <cite>CMakeLists.txt</cite> from <cite>src/user</cite> to your new git repository as
a template.</p></li>
<li><p>Replace the existing module list and source strings with the
source for your new module, just as in the instructions for Step 2
at the top of this section.</p></li>
<li><p><cite>git clone</cite> your repository into the <cite>extern/user-modules</cite>
directory with your new <cite>CMakeLists.txt</cite> in the top level of the
cloned repository.  You may include any number user module code
directories into <cite>extern/user-modules</cite>.  Just remember to use
unique names for each.</p></li>
<li><p>Now, when you build EXP, your private modules will be automatically
built for each directory and installed.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="design.html" class="btn btn-neutral float-left" title="Software design goals and features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="newforces.html" class="btn btn-neutral float-right" title="How to make a new EXP force" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2025, EXP-code collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>